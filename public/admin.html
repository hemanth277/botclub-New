<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Botclub | Admin Portal</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header>
    <a href="index.html" class="logo">Botclub</a>
    <nav>
      <a href="index.html">Home</a>
      <a href="dashboard.html" id="nav-dashboard" style="display: none;">Dashboard</a>
      <a href="admin.html" id="nav-admin" style="display: none;">Admin</a>
      <a href="cart.html" id="nav-cart" style="display: none;">Cart</a>
      <a href="login.html" id="nav-auth">Login</a>
    </nav>
  </header>

  <main class="container">
    <!-- Dashboard Overview -->
    <div class="animate-fade" style="margin-bottom: 3rem;">
      <h1 style="margin-bottom: 1.5rem;">Dashboard Overview</h1>

      <!-- Stats Grid -->
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="dash-card" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
          <span style="color: var(--text-muted); font-size: 0.9rem;">Total Users</span>
          <span style="font-size: 2rem; font-weight: 700;">1,248</span>
          <span style="color: #10b981; font-size: 0.8rem;">+12% this month</span>
        </div>
        <div class="dash-card" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
          <span style="color: var(--text-muted); font-size: 0.9rem;">Total Revenue</span>
          <span style="font-size: 2rem; font-weight: 700;">$48,290</span>
          <span style="color: #10b981; font-size: 0.8rem;">+8.5% this month</span>
        </div>
        <div class="dash-card" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
          <span style="color: var(--text-muted); font-size: 0.9rem;">Total Orders</span>
          <span style="font-size: 2rem; font-weight: 700;">3,402</span>
          <span style="color: #10b981; font-size: 0.8rem;">+24 today</span>
        </div>
        <div class="dash-card" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
          <span style="color: var(--text-muted); font-size: 0.9rem;">Active Now</span>
          <span style="font-size: 2rem; font-weight: 700;">42</span>
          <span style="color: #3b82f6; font-size: 0.8rem;">Currently online</span>
        </div>
      </div>

      <!-- Charts Section -->
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 3rem;">
        <div class="dash-card" style="padding: 1.5rem;">
          <h3 style="margin-bottom: 1rem;">Revenue Analytics</h3>
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="dash-card" style="padding: 1.5rem;">
          <h3 style="margin-bottom: 1rem;">New Users</h3>
          <canvas id="usersChart"></canvas>
          <div style="margin-top: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">Recent Activity</h4>
            <ul style="list-style: none; padding: 0;">
              <li style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem;">
                <span style="color: #10b981;">‚óè</span> New order #9421
              </li>
              <li style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem;">
                <span style="color: #3b82f6;">‚óè</span> User 'jdoe' registered
              </li>
              <li style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem;">
                <span style="color: #f59e0b;">‚óè</span> Stock warning: Belt
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-bottom: 2rem;">
      <button id="create-btn" onclick="showAddForm()"
        style="background: var(--primary); color: white; padding: 1rem 2rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 1.2rem;">+</span> Create New Product
      </button>
    </div>

    <div id="form-container" class="animate-fade"
      style="display: none; background: var(--bg-card); padding: 2rem; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.05);">
      <h2 id="form-title" style="margin-bottom: 2rem;">Add New Product</h2>
      <form id="product-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div style="grid-column: 1 / -1;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Product Name</label>
          <input type="text" id="name" required
            style="width: 100%; background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem 1rem; border-radius: 8px; color: white;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Price ($)</label>
          <input type="number" id="price" required step="0.01"
            style="width: 100%; background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem 1rem; border-radius: 8px; color: white;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Stock Quantity</label>
          <input type="number" id="stock" required
            style="width: 100%; background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem 1rem; border-radius: 8px; color: white;">
        </div>

        <div style="grid-column: 1 / -1;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Image URL</label>
          <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg"
            style="width: 100%; background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem 1rem; border-radius: 8px; color: white;">
        </div>

        <div style="grid-column: 1 / -1;">
          <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted);">Description</label>
          <textarea id="description" rows="4"
            style="width: 100%; background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); padding: 0.75rem 1rem; border-radius: 8px; color: white;"></textarea>
        </div>

        <div style="grid-column: 1 / -1; display: flex; gap: 1rem;">
          <button type="submit"
            style="flex: 1; background: var(--primary); color: white; padding: 1rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: var(--transition);">Save
            Product</button>
          <button type="button" id="cancel-edit" onclick="resetForm()"
            style="background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition);">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Product List Section -->
    <div class="animate-fade" style="margin-top: 3rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2>Manage Products</h2>
        <button onclick="deleteAllProducts()"
          style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: var(--transition);">
          Delete All Products
        </button>
      </div>
      <div id="product-list"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
        <!-- Products will be loaded here -->
      </div>
    </div>
  </main>

  <script src="nav.js"></script>
  <script src="config.js"></script>
  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || user.role !== 'admin') {
      alert('Access Denied: Admins Only');
      window.location.href = 'index.html';
    }

    // Initialize Charts
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
      type: 'line',
      data: {
        labels: ['Feb 1', 'Feb 3', 'Feb 5', 'Feb 7', 'Feb 9', 'Feb 11', 'Feb 13'],
        datasets: [{
          label: 'Revenue ($)',
          data: [1200, 1900, 3000, 2500, 3200, 4500, 4829],
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
          x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
        }
      }
    });

    const usersCtx = document.getElementById('usersChart').getContext('2d');
    new Chart(usersCtx, {
      type: 'doughnut',
      data: {
        labels: ['Direct', 'Social', 'Referral'],
        datasets: [{
          data: [55, 30, 15],
          backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }
      }
    });



    let editingProductId = null;
    let allProducts = [];

    async function loadProducts() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/products`);
        allProducts = await res.json();
        const container = document.getElementById('product-list');

        container.innerHTML = allProducts.map(p => `
          <div class="dash-card" style="padding: 1.5rem; display: flex; flex-direction: column; height: 100%;">
            <div style="margin-bottom: 1rem; border-radius: 8px; overflow: hidden; height: 150px; background: var(--bg-dark);">
              <img src="${p.imageUrl || 'https://placehold.co/300x200?text=No+Image'}" 
                alt="${p.name}" 
                style="width: 100%; height: 100%; object-fit: cover;"
                onerror="this.src='https://placehold.co/300x200?text=Image+Error'">
            </div>
            <div style="flex-grow: 1;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <h3 style="font-size: 1.1rem; font-weight: 600;">${p.name}</h3>
                <span style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">$${p.price}</span>
              </div>
              <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${p.description || 'No description'}</p>
              <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                <span>üì¶ Stock: ${p.stock}</span>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem;">
              <button onclick="editProduct('${p._id}')" 
                style="background: transparent; border: 1px solid rgba(59, 130, 246, 0.5); color: #3b82f6; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: var(--transition);">
                Edit
              </button>
              <button onclick="deleteProduct('${p._id}')" 
                style="background: transparent; border: 1px solid rgba(239, 68, 68, 0.5); color: #ef4444; padding: 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: var(--transition);">
                Delete
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Failed to load products', err);
      }
    }

    function showAddForm() {
      resetForm();
      document.getElementById('form-container').style.display = 'block';
      document.getElementById('form-title').textContent = 'Add New Product';
      document.getElementById('create-btn').style.display = 'none';
      document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
    }

    function editProduct(id) {
      const product = allProducts.find(p => p._id === id);
      if (!product) return;

      editingProductId = id;

      document.getElementById('name').value = product.name;
      document.getElementById('price').value = product.price;
      document.getElementById('stock').value = product.stock;
      document.getElementById('imageUrl').value = product.imageUrl || '';
      document.getElementById('description').value = product.description || '';

      const submitBtn = document.querySelector('button[type="submit"]');
      submitBtn.textContent = 'Update Product';
      submitBtn.style.background = '#3b82f6';

      document.getElementById('form-container').style.display = 'block';
      document.getElementById('form-title').textContent = 'Edit Product';
      document.getElementById('create-btn').style.display = 'none';

      // Scroll to form
      document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
    }

    window.deleteProduct = async (id) => {
      if (confirm('Delete this product?')) {
        try {
          const res = await fetch(`${API_BASE_URL}/api/products/${id}`, { method: 'DELETE' });
          if (res.ok) {
            loadProducts();
          } else {
            alert('Failed to delete product');
          }
        } catch (err) {
          console.error(err);
          alert('Error deleting product');
        }
      }
    };

    async function deleteAllProducts() {
      if (!confirm('DANGER: Are you sure you want to delete ALL products? This cannot be undone.')) return;

      const btn = document.querySelector('button[onclick="deleteAllProducts()"]');
      const originalText = btn.textContent;
      btn.textContent = 'Deleting...';
      btn.disabled = true;

      try {
        const res = await fetch(`${API_BASE_URL}/api/products`, { method: 'DELETE' });

        if (res.ok) {
          const data = await res.json();
          alert(data.message);
          loadProducts();
        } else {
          const text = await res.text();
          alert('Server Error: ' + text);
        }
      } catch (err) {
        console.error(err);
        alert('Connection error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    function resetForm() {
      editingProductId = null;
      document.getElementById('product-form').reset();
      const submitBtn = document.querySelector('button[type="submit"]');
      submitBtn.textContent = 'Save Product';
      submitBtn.style.background = 'var(--primary)';

      document.getElementById('form-container').style.display = 'none';
      document.getElementById('create-btn').style.display = 'flex';
    }

    document.getElementById('product-form').onsubmit = async (e) => {
      e.preventDefault();
      const productData = {
        name: document.getElementById('name').value,
        price: parseFloat(document.getElementById('price').value),
        stock: parseInt(document.getElementById('stock').value),
        imageUrl: document.getElementById('imageUrl').value,
        description: document.getElementById('description').value,
      };

      try {
        const url = editingProductId ? `${API_BASE_URL}/api/products/${editingProductId}` : `${API_BASE_URL}/api/products`;
        const method = editingProductId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });

        if (res.ok) {
          alert(editingProductId ? 'Product updated!' : 'Product added!');
          resetForm();
          loadProducts();
        } else {
          // Try to parse JSON, if fails, read text
          const contentType = res.headers.get("content-type");
          if (contentType && contentType.indexOf("application/json") !== -1) {
            const data = await res.json();
            alert(data.message);
          } else {
            const text = await res.text();
            alert('Server Error: ' + text);
          }
        }
      } catch (err) {
        console.error(err);
        alert('Connection error: ' + err.message);
      }
    };

    // Initial load
    loadProducts();

    // Logout handled by nav.js
  </script>
</body>

</html>